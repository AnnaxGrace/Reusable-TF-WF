name: Reusable Plan and Apply

on: 
    workflow_call:
        secrets:
            TF_vars:
                required: false


permissions:
    id-token: write
    contents: read

jobs:
  run-tf:
    runs-on: ubuntu-latest

    steps: 

    - uses: actions/checkout@v4

    - run: |
        echo "tf_vars"
        echo $TF_vars
        echo "secrets"
        echo ${{ secrets.TF_vars }}
        ls

    - name: 'Create Terraform Secrets tfvars File'
      run: |
        ls
        # TERRAFORM_SECRET_VARIABLES=$(env | grep -e '^TF_VAR_')
        touch secrets.tfvars
        cat > secrets.tfvars << EOF
        ${{ secrets.TF_vars }}
        EOF
      working-directory: terraform

    - uses: actions/upload-artifact@v4
      with:
        name: secrets
        path: terraform/secrets.tfvars

    - run: |
        for i in $TF_vars; do
            echo $i
            # i=$(echo $i | sed 's/=.*//g')=$(echo ${i#*=} | base64 -di | base64 -di)
            # echo ::add-mask::${i#*=}
            # printf '%s\n' "$i" >> $GITHUB_ENV
          done
    

    - name: 'Plan Run'
      run: |
        terraform init
        terraform plan -input=false -var-file=./secrets.tfvars
        # terraform plan -input=false 
      working-directory: terraform

    # - name: 'Apply Run'
    #   run: |
    #     terraform apply -auto-approve -input=false -var-file=./secrets.tfvars
    #   working-directory: terraform
